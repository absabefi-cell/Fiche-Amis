<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche identité client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 10px;
            background: #f2f2f7;
        }
        h2, h3 {
            margin: 8px 0;
            font-size: 1.2rem;
        }
        .card {
            border-radius: 12px;
            background: #ffffff;
            padding: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 14px;
            border: 1px solid #e0e0e0;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .card-header-title {
            font-weight: 600;
            font-size: 1rem;
        }
        .card-header-sub {
            font-size: 0.8rem;
            color: #666;
        }
        label {
            display: block;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            margin-top: 3px;
            font-size: 0.95rem;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        textarea {
            resize: vertical;
        }
        input[type="file"] {
            margin-top: 5px;
            font-size: 0.9rem;
        }
        .ligne-deux {
            display: flex;
            gap: 8px;
        }
        .ligne-deux > div {
            flex: 1;
        }
        .btn-row {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 10px;
            font-size: 0.95rem;
            border-radius: 8px;
            border: none;
            background: #007bff;
            color: #fff;
        }
        button:active {
            opacity: 0.85;
        }
        button.danger {
            background: #e53935;
        }
        button.secondary {
            background: #555;
        }
        img#photoPreview {
            margin-top: 8px;
            max-width: 100%;
            max-height: 180px;
            display: none;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .table-wrapper {
            margin-top: 4px;
            background: #ffffff;
            border-radius: 10px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 340px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            font-size: 0.8rem;
            text-align: left;
        }
        th {
            background: #f5f5f5;
        }
        tr:hover {
            background: #f0f0f0;
            cursor: pointer;
        }
        .small-text {
            font-size: 0.75rem;
            color: #777;
            margin-top: 4px;
        }
        /* fiche identité affichage */
        .fiche-container {
            display: none; /* caché tant qu’aucune fiche choisie */
        }
        .fiche-visible {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .fiche-photo {
            flex: 0 0 110px;
        }
        .fiche-photo img {
            width: 110px;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .fiche-infos {
            flex: 1;
            font-size: 0.9rem;
        }
        .fiche-ligne {
            margin-bottom: 4px;
        }
        .fiche-label {
            font-weight: 600;
        }

        @media (max-width: 600px) {
            body {
                margin: 6px;
            }
            h2, h3 {
                font-size: 1.1rem;
            }
            .btn-row {
                flex-direction: column;
            }
            .btn-row button {
                width: 100%;
            }
            .fiche-visible {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">
        <div class="card-header-title">Fiche identité</div>
        <div class="card-header-sub">Création / modification / sauvegarde locale</div>
    </div>

    <form id="clientForm">
        <!-- champs cachés -->
        <input type="hidden" id="clientId">
        <input type="hidden" id="photoData">

        <div class="ligne-deux">
            <div>
                <label>Nom:</label>
                <input type="text" id="nom" required>
            </div>
            <div>
                <label>Prénom:</label>
                <input type="text" id="prenom" required>
            </div>
        </div>

        <label>N° d'identité (CIN / ID) :</label>
        <input type="text" id="identifiant" maxlength="20" required placeholder="">

        <div class="ligne-deux">
            <div>
                <label>Date de naissance:</label>
                <input type="date" id="dateNaissance">
            </div>
            <div>
                <label>Lieu de naissance:</label>
                <input type="text" id="lieuNaissance">
            </div>
        </div>

        <label>Adresse:</label>
        <textarea id="adresse" rows="2"></textarea>

        <label>E-mail:</label>
        <input type="email" id="email">

        <label>Téléphone (+212):</label>
        <input type="tel" id="telephone" value="+212" required>

        <label>Photo (caméra ou galerie):</label>
        <input type="file" id="photo" accept="image/*" capture="environment">
        <img id="photoPreview" alt="Prévisualisation photo">
        <div class="small-text">La photo est sauvegardée dans le téléphone (localStorage), rien n'est envoyé sur Internet.</div>

        <div class="btn-row">
            <button type="button" onclick="nouveauClient()">Nouveau</button>
            <button type="button" onclick="enregistrerClient()">Enregistrer</button>
            <button type="button" class="danger" onclick="supprimerClient()">Supprimer</button>
            <button type="button" class="secondary" onclick="afficherListe()">Rafraîchir la liste</button>
        </div>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-header-title">Recherche / liste</div>
    </div>

    <label>Rechercher par nom:</label>
    <input type="text" id="searchNom" placeholder="Tape le nom pour filtrer...">

    <div class="table-wrapper">
        <table id="clientTable">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Prénom</th>
                    <th>ID</th>
                    <th>Téléphone</th>
                </tr>
            </thead>
            <tbody>
                <!-- lignes générées par JS -->
            </tbody>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-header-title">Fiche identité (aperçu)</div>
        <div class="card-header-sub">Cliquer sur une ligne pour afficher la fiche complète</div>
    </div>

    <div id="ficheAffichage" class="fiche-container">
        <div class="fiche-photo">
            <img id="fichePhoto" src="" alt="Photo identité">
        </div>
        <div class="fiche-infos">
            <div class="fiche-ligne"><span class="fiche-label">Nom :</span> <span id="ficheNom"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">Prénom :</span> <span id="fichePrenom"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">N° d'identité :</span> <span id="ficheID"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">Date de naissance :</span> <span id="ficheDateN"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">Lieu de naissance :</span> <span id="ficheLieuN"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">Téléphone :</span> <span id="ficheTel"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">E-mail :</span> <span id="ficheMail"></span></div>
            <div class="fiche-ligne"><span class="fiche-label">Adresse :</span> <span id="ficheAdresse"></span></div>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = "fiches_identite_clients";

    function chargerClients() {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return [];
        try {
            return JSON.parse(data);
        } catch (e) {
            return [];
        }
    }

    function sauvegarderClients(clients) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(clients));
    }

    function afficherListe() {
        const search = (document.getElementById("searchNom").value || "").trim().toLowerCase();
        const clients = chargerClients();
        const tbody = document.querySelector("#clientTable tbody");
        tbody.innerHTML = "";

        clients
            .filter(function(c) {
                const nom = (c.nom || "").toLowerCase();
                return nom.includes(search);
            })
            .forEach(function(c) {
                const tr = document.createElement("tr");
                tr.onclick = function() {
                    chargerDansFormulaire(c.id);
                    afficherFiche(c);
                };

                const tdNom = document.createElement("td");
                const tdPrenom = document.createElement("td");
                const tdID = document.createElement("td");
                const tdTel = document.createElement("td");

                tdNom.textContent = c.nom || "";
                tdPrenom.textContent = c.prenom || "";
                tdID.textContent = c.identifiant || "";
                tdTel.textContent = c.telephone || "";

                tr.appendChild(tdNom);
                tr.appendChild(tdPrenom);
                tr.appendChild(tdID);
                tr.appendChild(tdTel);

                tbody.appendChild(tr);
            });
    }

    function nouveauClient() {
        document.getElementById("clientId").value = "";
        document.getElementById("photoData").value = "";
        document.getElementById("nom").value = "";
        document.getElementById("prenom").value = "";
        document.getElementById("identifiant").value = "";
        document.getElementById("dateNaissance").value = "";
        document.getElementById("lieuNaissance").value = "";
        document.getElementById("adresse").value = "";
        document.getElementById("email").value = "";
        document.getElementById("telephone").value = "+212";
        document.getElementById("photo").value = "";
        const img = document.getElementById("photoPreview");
        img.style.display = "none";
        img.src = "";

        // cacher la fiche affichage
        const fiche = document.getElementById("ficheAffichage");
        fiche.className = "fiche-container";
        document.getElementById("fichePhoto").src = "";
    }

    function enregistrerClient() {
        const id = document.getElementById("clientId").value;
        const nom = document.getElementById("nom").value.trim();
        const prenom = document.getElementById("prenom").value.trim();
        const identifiant = document.getElementById("identifiant").value.trim();
        const dateNaissance = document.getElementById("dateNaissance").value;
        const lieuNaissance = document.getElementById("lieuNaissance").value.trim();
        const adresse = document.getElementById("adresse").value.trim();
        const email = document.getElementById("email").value.trim();
        const telephone = document.getElementById("telephone").value.trim();
        const photoData = document.getElementById("photoData").value;

        if (!nom || !prenom || !identifiant || !telephone) {
            alert("Nom, prénom, identifiant et téléphone sont obligatoires.");
            return;
        }

        let clients = chargerClients();

        if (id) {
            const index = clients.findIndex(function(c) { return c.id === id; });
            if (index !== -1) {
                clients[index].nom = nom;
                clients[index].prenom = prenom;
                clients[index].identifiant = identifiant;
                clients[index].dateNaissance = dateNaissance;
                clients[index].lieuNaissance = lieuNaissance;
                clients[index].adresse = adresse;
                clients[index].email = email;
                clients[index].telephone = telephone;
                if (photoData) {
                    clients[index].photo = photoData;
                }
                afficherFiche(clients[index]);
            }
        } else {
            const newId = Date.now().toString();
            const nouveau = {
                id: newId,
                nom: nom,
                prenom: prenom,
                identifiant: identifiant,
                dateNaissance: dateNaissance,
                lieuNaissance: lieuNaissance,
                adresse: adresse,
                email: email,
                telephone: telephone,
                photo: photoData || ""
            };
            clients.push(nouveau);
            document.getElementById("clientId").value = newId;
            afficherFiche(nouveau);
        }

        sauvegarderClients(clients);
        afficherListe();
        alert("Fiche identité enregistrée.");
    }

    function supprimerClient() {
        const id = document.getElementById("clientId").value;
        if (!id) {
            alert("Aucune fiche sélectionnée.");
            return;
        }

        if (!confirm("Supprimer cette fiche identité ?")) return;

        let clients = chargerClients();
        clients = clients.filter(function(c) { return c.id !== id; });
        sauvegarderClients(clients);
        nouveauClient();
        afficherListe();
    }

    function chargerDansFormulaire(id) {
        const clients = chargerClients();
        const c = clients.find(function(x) { return x.id === id; });
        if (!c) return;

        document.getElementById("clientId").value = c.id;
        document.getElementById("nom").value = c.nom || "";
        document.getElementById("prenom").value = c.prenom || "";
        document.getElementById("identifiant").value = c.identifiant || "";
        document.getElementById("dateNaissance").value = c.dateNaissance || "";
        document.getElementById("lieuNaissance").value = c.lieuNaissance || "";
        document.getElementById("adresse").value = c.adresse || "";
        document.getElementById("email").value = c.email || "";
        document.getElementById("telephone").value = c.telephone || "+212";

        if (c.photo) {
            document.getElementById("photoData").value = c.photo;
            const img = document.getElementById("photoPreview");
            img.src = c.photo;
            img.style.display = "block";
        } else {
            document.getElementById("photoData").value = "";
            const img = document.getElementById("photoPreview");
            img.style.display = "none";
            img.src = "";
        }
    }

    function afficherFiche(c) {
        const fiche = document.getElementById("ficheAffichage");
        fiche.className = "fiche-container fiche-visible";

        document.getElementById("ficheNom").textContent = c.nom || "";
        document.getElementById("fichePrenom").textContent = c.prenom || "";
        document.getElementById("ficheID").textContent = c.identifiant || "";
        document.getElementById("ficheDateN").textContent = c.dateNaissance || "";
        document.getElementById("ficheLieuN").textContent = c.lieuNaissance || "";
        document.getElementById("ficheTel").textContent = c.telephone || "";
        document.getElementById("ficheMail").textContent = c.email || "";
        document.getElementById("ficheAdresse").textContent = c.adresse || "";

        const imgFiche = document.getElementById("fichePhoto");
        if (c.photo) {
            imgFiche.src = c.photo;
        } else {
            imgFiche.src = "";
        }
    }

    document.getElementById("photo").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const dataUrl = e.target.result;
            document.getElementById("photoData").value = dataUrl;
            const img = document.getElementById("photoPreview");
            img.src = dataUrl;
            img.style.display = "block";
        };
        reader.readAsDataURL(file);
    });

    document.getElementById("searchNom").addEventListener("input", function() {
        afficherListe();
    });

    window.onload = function() {
        afficherListe();
    };
</script>

</body>
</html>
